#!/bin/sh
VERSION=`cat VERSION`
TGZ_DEST="$HOME/shiro.dreamhost.com/scheme/vault/"
MAN_DEST="$HOME/shiro.dreamhost.com/scheme/gauche/man/"
CHANGELOG_DEST="$HOME/shiro.dreamhost.com/scheme/gauche/ChangeLog.txt"

case $1 in
  -all) docs=yes; tgz=yes;;
  -doc) docs=yes; tgz=no;;
  -tgz)    docs=no; tgz=yes;;
  *) echo "DIST -all|-doc|-tgz"; exit 0;;
esac

if [ "$tgz" = "yes" ]; then
  rm -f DIST_EXCLUDE_X
  cat DIST_EXCLUDE > DIST_EXCLUDE_X
  (cd ..; find Gauche -name CVS -print -prune) >> DIST_EXCLUDE_X

  if [ -f Makefile ]; then make realclean; fi
  ./AUTOCONF
  configure
  (cd src; for stub in *.stub; do make `echo $stub | sed 's/\.stub/.c/'` ; done)
  (cd doc; make html)
  make distclean
  escm -o INSTALL INSTALL.esc
  LANG=ja_JP escm -o INSTALL.eucjp INSTALL.esc
  (cd ..; tar c -v -f - -X Gauche/DIST_EXCLUDE_X Gauche | gzip -9 > Gauche-$VERSION.tgz)
  mv ../Gauche-$VERSION.tgz $TGZ_DEST
  cp ChangeLog $CHANGELOG_DEST
fi

if [ "$docs" = "yes" ]; then
  cp doc/gauche-ref.texi doc/Makefile $MAN_DEST
  (cd $MAN_DEST; make htmls)
  rm -f $MAN_DEST/gauche-ref.texi $MAN_DEST/Makefile
fi
