srcdir       = @srcdir@
top_builddir = @top_builddir@
top_srcdir   = @top_srcdir@

include ../Makefile.ext

SCM_CATEGORY = dbm

LIBFILES = @DBM_ARCHFILES@
SCMFILES = @DBM_SCMFILES@

GENERATED = Makefile dbmconf.h
XCLEANFILES = gdbm-lib.c gdbm.scm \
              ndbm-lib.c ndbm.scm \
              odbm-lib.c odbm.scm \
              ndbm-makedb ndbm-suffixes.h *_head.c *_tail.c

all : $(LIBFILES)

gdbm_OBJECTS   = gdbm_head.$(OBJEXT) gdbm-lib.$(OBJEXT) gdbm_tail.$(OBJEXT)

gdbm-lib.$(SOEXT) : $(gdbm_OBJECTS)
	$(MODLINK) gdbm-lib.$(SOEXT) $(gdbm_OBJECTS) $(EXT_LIBGAUCHE) @GDBMLIB@ $(LIBS)

gdbm.scm gdbm-lib.c : gdbm-lib.scm
	$(PRECOMP) --ext-module=gdbm.scm gdbm-lib.scm

ndbm_OBJECTS   = ndbm_head.$(OBJEXT) ndbm-lib.$(OBJEXT) ndbm_tail.$(OBJEXT)

ndbm-lib.$(SOEXT) : $(ndbm_OBJECTS)
	$(MODLINK) ndbm-lib.$(SOEXT) $(ndbm_OBJECTS) $(EXT_LIBGAUCHE) @NDBMLIB@ $(LIBS)

ndbm.scm ndbm-lib.c : ndbm-lib.scm
	$(PRECOMP) --ext-module=ndbm.scm ndbm-lib.scm

ndbm-lib.$(OBJEXT): ndbm-lib.c ndbm-suffixes.h

odbm_OBJECTS   = odbm_head.$(OBJEXT) odbm-lib.$(OBJEXT) odbm_tail.$(OBJEXT)

odbm-lib.$(SOEXT) : $(odbm_OBJECTS)
	$(MODLINK) odbm-lib.$(SOEXT) $(odbm_OBJECTS) $(EXT_LIBGAUCHE) @ODBMLIB@ $(LIBS)

odbm.scm odbm-lib.c : odbm-lib.scm
	$(PRECOMP) --ext-module=odbm.scm odbm-lib.scm

gdbm_head.c gdbm_tail.c :
	$(GAUCHE_CONFIG) --fixup-extension gdbm

ndbm_head.c ndbm_tail.c :
	$(GAUCHE_CONFIG) --fixup-extension ndbm

odbm_head.c odbm_tail.c :
	$(GAUCHE_CONFIG) --fixup-extension odbm

# auxiliary stuff.
# a bit tricky,
ndbm-makedb : ndbm-makedb.c
	$(CC) $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) -o ndbm-makedb \
	  ndbm-makedb.c $(LOCAL_LFLAGS) $(XLDFLAGS) @NDBMLIB@ $(LIBS)

ndbm-suffixes.h : ndbm-makedb ndbm-suffixes.scm
	$(GOSH) ./ndbm-suffixes.scm ndbm-suffixes.h

install : install-std

