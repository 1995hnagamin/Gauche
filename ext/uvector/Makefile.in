CC = @CC@
OPTFLAGS = @OPTFLAGS@
CFLAGS = @CFLAGS@ $(OPTFLAGS)
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
GOSH = @GOSH@
GAUCHE_CONFIG = @GAUCHE_CONFIG@
GAUCHE_TOP = @GAUCHE_TOP@
INSTALL = @LIBTOOL@ --mode=install @INSTALL@
LIBTOOL = @LIBTOOL@
top_builddir = $(GAUCHE_TOP)

ARCHFILES = libuvector.la
SCMFILES  = uvector.scm array.scm srfi-4.scm
HEADERS   = uvector.h

TARGET    = libuvector.la
OBJS      = uvector_head.lo uvector.lo uvutil.lo uvlib.lo uvector_tail.lo
CONFIG_GENERATED = Makefile config.cache config.log config.status \
		   autom4te*.cache libtool uvector_head.c uvector_tail.c
GENERATED = gauche/uvector.h uvector.c uvutil.c uvlib.c uvlib.stub

INSTALL_TYPE = @INSTALL_TYPE@
HEADER_INSTALL_DIR  = `$(GAUCHE_CONFIG) --$(INSTALL_TYPE)incdir`/gauche
SCM_INSTALL_DIR     = `$(GAUCHE_CONFIG) --$(INSTALL_TYPE)libdir`
ARCH_INSTALL_DIR    = `$(GAUCHE_CONFIG) --$(INSTALL_TYPE)archdir`

.SUFFIXES: .lo

.c.lo:
	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c $< -o $@

all : $(TARGET)

libuvector.la : $(OBJS)
	$(LIBTOOL) --mode=link $(CC) -module -avoid-version -rpath $(ARCH_INSTALL_DIR) $(LDFLAGS) libuvector.la $(OBJS) $(LIBS)

$(OBJS) : gauche/uvector.h uvectorP.h

gauche/uvector.h : uvector.h.sh
	if test ! -d gauche; then mkdir gauche; fi
	rm -rf gauche/uvector.h
	sh ./uvector.h.sh > gauche/uvector.h

uvector.c : uvector.c.sh
	rm -rf uvector.c
	sh ./uvector.c.sh > uvector.c

uvutil.c : uvutil.c.sh
	rm -rf uvutil.c
	sh ./uvutil.c.sh > uvutil.c

uvlib.c : uvlib.stub
	$(GOSH) genstub uvlib.stub

uvlib.stub : uvlib.stub.sh
	rm -rf uvlib.stub
	sh ./uvlib.stub.sh > uvlib.stub

check : test

test : all
	@rm -f test.log
	$(GOSH) -I. test.scm > test.log

install : all
	@for f in gauche/$(HEADERS) _end; do \
	  if test $$f != _end; then \
	    $(INSTALL) -m 444 $$f $(HEADER_INSTALL_DIR); \
	  fi; \
	done
	$(INSTALL) -m 444 uvector.scm $(SCM_INSTALL_DIR)/gauche
	$(INSTALL) -m 444 array.scm $(SCM_INSTALL_DIR)/gauche
	$(INSTALL) -m 444 srfi-4.scm $(SCM_INSTALL_DIR)
	@for f in $(ARCHFILES) _end; do \
	  if test $$f != _end; then \
	    $(INSTALL) -m 555 $$f $(ARCH_INSTALL_DIR); \
	  fi; \
	done

clean :
	rm -rf core $(TARGET) $(OBJS) $(OBJS:.lo=.o) *~ test.log so_locations
	rm -rf .libs _libs

distclean : clean
	rm -rf $(CONFIG_GENERATED) gauche

maintainer-clean : realclean

realclean : clean
	rm -rf $(CONFIG_GENERATED) $(GENERATED) gauche configure

# 'link' creates symlinks from source tree to extension modules, so that
# it can be tested within the source tree.  'unlink' removes them.
# these are only for developer's.

link : $(TARGET) $(SCMFILES)
	$(GOSH) ../xlink -l $(TARGET) 
	$(GOSH) ../xlink -l srfi-4.scm
	$(GOSH) ../xlink -l -d gauche uvector.scm array.scm

unlink :
	-$(GOSH) ../xlink -u $(TARGET)
	-$(GOSH) ../xlink -u srfi-4.scm
	-$(GOSH) ../xlink -u -d gauche uvector.scm array.scm
