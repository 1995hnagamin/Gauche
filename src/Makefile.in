SCM = snow
CC = @CC@
CFLAGS = -g -O2 -I. -I../gc -I../gc/include
#CFLAGS = -O2 -I. -I../gc -I../gc/include
LIBS = @LIBS@
LDFLAGS = -lm
AR = ar

prefix = @prefix@
exec_prefix = @exec_prefix@

GENERATED = stdlib.c extlib.c gauche-config

HEADER_INSTALL_DIR = @includedir@
SUBHEADER_INSTALL_DIR = @includedir@/gauche
LIB_INSTALL_DIR = @libdir@
BIN_INSTALL_DIR = @bindir@
SCM_INSTALL_DIR = @libdir@/gauche/@GAUCHE_VERSION@/lib

INSTALL_HEADERS = gauche.h ../gc/gc.h 
INSTALL_SUBHEADERS = gauche/char_euc_jp.h gauche/vm.h gauche/vminsn.h
INSTALL_LIBS = libgauche.a
INSTALL_BINS = gosh gauche-config
INSTALL_SCMS = genstub

INSTALL=@INSTALL@

GCLIB = ../gc/gc.a

OBJS = core.o vm.o compile.o error.o class.o boolean.o char.o \
       string.o list.o port.o hash.o write.o read.o vector.o symbol.o \
       module.o proc.o number.o io.o load.o file.o promise.o repl.o \
       stdlib.o extlib.o

.SUFFIXES: .stub

.stub.c:
	$(SCM) genstub $<

HDRS = gauche.h

all : gosh

gosh : libgauche.a main.o
	$(CC) $(CFLAGS) -o gosh main.o -L. -lgauche $(LDFLAGS)

$(OBJS) main.o : $(HDRS)

stdlib.c : stdlib.stub genstub 
extlib.c : extlib.stub genstub

libgauche.a : $(OBJS) $(GCLIB)
	$(AR) x $(GCLIB)
	$(AR) r libgauche.a $(OBJS) `$(AR) t $(GCLIB)`

clean :
	rm -f core gosh *.o *~ *.a $(GENERATED) gauche/*~

install : all
	for f in $(INSTALL_HEADERS); do \
	  $(INSTALL) -m 444 $$f $(HEADER_INSTALL_DIR); \
	done
	for f in $(INSTALL_SUBHEADERS); do \
	  $(INSTALL) -m 444 $$f $(SUBHEADER_INSTALL_DIR); \
	done
	for f in $(INSTALL_LIBS); do \
	  $(INSTALL) -m 444 $$f $(LIB_INSTALL_DIR); \
	done
	for f in $(INSTALL_BINS); do \
	  $(INSTALL) -m 555 $$f $(BIN_INSTALL_DIR); \
	done
	$(INSTALL) -d $(SCM_INSTALL_DIR)
	for f in $(INSTALL_SCMS); do \
	  $(INSTALL) -m 444 $$f $(SCM_INSTALL_DIR); \
	done



